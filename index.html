<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunar Lander - 月面着陸ゲーム</title>
    <style>
        body {
            background-color: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            font-size: 14px;
        }
        
        .terminal {
            background-color: #001100;
            border: 2px solid #00ff00;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 5px;
            box-shadow: 0 0 20px #00ff0050;
        }
        
        .title {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .game-area {
            white-space: pre-line;
            line-height: 1.2;
            margin: 20px 0;
            min-height: 400px;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
        }
        
        .text-display {
            flex: 1;
            margin-right: 20px;
            min-height: 400px;
        }
        
        .visual-display {
            width: 400px;
            height: 400px;
            border: 1px solid #00ff00;
            background-color: #000800;
            position: relative;
        }
        
        canvas {
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        
        .demo-mode {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ff00;
            font-size: 16px;
            font-weight: bold;
            animation: blink 1s infinite;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 15px;
            border: 1px solid #00ff00;
            border-radius: 3px;
        }
        
        .status {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #00ff00;
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #003300;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            margin: 5px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            border-radius: 3px;
        }
        
        button:hover {
            background-color: #004400;
            box-shadow: 0 0 5px #00ff00;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .red { color: #ff0000; }
        .yellow { color: #ffff00; }
        .cyan { color: #00ffff; }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="title">*** LUNAR LANDER ***</div>
        
        <div class="status">
            <div>高度: <span id="altitude">1000</span>m</div>
            <div>速度: <span id="velocity">0</span>m/s</div>
            <div>燃料: <span id="fuel">100</span>%</div>
        </div>
        
        <div class="game-area">
            <div class="text-display" id="gameArea"></div>
            <div class="visual-display">
                <canvas id="gameCanvas" width="400" height="400"></canvas>
                <div id="demoText" class="demo-mode" style="display: none;">
                    DEMO MODE - 何かキーを押してプレイ開始
                </div>
                <div class="controls-info" style="position: absolute; bottom: -50px; left: 0; right: 0; text-align: center; font-size: 12px; color: #00ff00;">
                    操作: [T]キーまたは[推進]ボタンでエンジン点火<br>
                    目標: 速度5m/s以下で月面に着陸
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button id="thrustBtn" onclick="thrust()">推進 (T)</button>
            <button id="startBtn" onclick="startGame()">ゲーム開始</button>
            <button onclick="showInstructions()">操作説明</button>
        </div>
        
        <div id="messages"></div>
    </div>

    <script>
        let gameState = {
            altitude: 1000,
            velocity: 0,
            fuel: 100,
            thrustPower: 0,
            gravity: 1.6, // 月の重力
            gameRunning: false,
            gameOver: false,
            isDemo: false,
            lastUserInput: Date.now(),
            demoActionTimer: 0
        };

        let gameInterval;
        let displayText = '';
        
        // キャンバスとコンテキストを取得
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function initGame() {
            gameState = {
                altitude: 1000,
                velocity: 0,
                fuel: 100,
                thrustPower: 0,
                gravity: 0.8,
                gameRunning: false,
                gameOver: false,
                isDemo: false,
                lastUserInput: Date.now() - 3000, // 3秒前に設定してデモが早く開始されるように
                demoActionTimer: 0
            };
            updateDisplay();
            showWelcomeMessage();
        }

        function showWelcomeMessage() {
            displayText = `
=== 月面着陸ミッション ===

月面着陸船を操縦して安全に着陸させてください。

目標: 速度5m/s以下で月面に着陸
警告: 速度が速すぎると墜落します！

燃料は限られています。慎重に使用してください。

準備はよろしいですか？
            `;
            document.getElementById('gameArea').innerHTML = displayText;
        }

        function showInstructions() {
            displayText = `
=== 操作説明 ===

• [推進]ボタンまたは[T]キー: エンジン推進
• エンジンは重力に逆らって上向きの力を与えます
• 燃料が尽きるとエンジンは使用できません
• 高度0mで速度5m/s以下なら着陸成功
• 速度が速すぎると墜落します

物理法則:
• 重力: 1.6m/s²（月面）
• 推進力: 3.0m/s²

頑張って！
            `;
            document.getElementById('gameArea').innerHTML = displayText;
        }

        function startGame() {
            if (gameState.gameRunning) return;
            
            // デモモードを終了
            if (gameState.isDemo) {
                stopDemo();
            }
            
            // ゲーム状態をリセット
            gameState = {
                altitude: 1000,
                velocity: 0,
                fuel: 100,
                thrustPower: 0,
                gravity: 0.8,  // 重力を半分に
                gameRunning: true,
                gameOver: false,
                isDemo: false,
                lastUserInput: Date.now(),
                demoActionTimer: 0
            };
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'ゲーム開始';
            
            displayText = `
ミッション開始！

月面着陸船が降下を開始しました。
燃料を管理しながら安全に着陸させてください。

            `;
            document.getElementById('gameArea').innerHTML = displayText;
            
            gameInterval = setInterval(gameLoop, 100);
        }

        function thrust() {
            if (!gameState.gameRunning || gameState.gameOver || gameState.fuel <= 0) return;
            
            gameState.thrustPower = 2.5;  // 推進力を強化
            gameState.fuel = Math.max(0, gameState.fuel - 0.8);  // 燃料消費を減らす
            
            // 推進エフェクトを一定時間維持
            setTimeout(() => {
                if (gameState.gameRunning && !gameState.gameOver) {
                    gameState.thrustPower = 0;
                }
            }, 300);  // 効果時間を延長
        }

        function gameLoop() {
            // デモモードのチェック（ゲーム開始前のみ）
            if (!gameState.gameRunning && !gameState.gameOver) {
                checkDemoMode();
            }
            
            // デモモード中はAIが操作
            if (gameState.isDemo) {
                updateDemoAI();
                
                // デモモード中のゲームオーバー時は自動再開
                if (gameState.gameOver) {
                    setTimeout(() => {
                        initGame();
                        gameState.isDemo = true;
                        document.getElementById('demoText').style.display = 'block';
                        setTimeout(() => {
                            if (gameState.isDemo) {
                                startGame();
                            }
                        }, 2000);
                    }, 3000);
                }
            }
            
            if (gameState.gameRunning && !gameState.gameOver) {
                // 物理計算（重力は下向き、推進は上向き）
                let netAcceleration = gameState.gravity - gameState.thrustPower;
                gameState.velocity += netAcceleration * 0.1;
                gameState.altitude -= gameState.velocity * 0.1;

                updateDisplay();
                updateGameArea();

                // ゲーム終了条件チェック
                if (gameState.altitude <= 0) {
                    gameState.altitude = 0;
                    endGame();
                }
            }
            
            // キャンバスを更新
            drawGame();
        }

        function updateDisplay() {
            document.getElementById('altitude').textContent = Math.round(gameState.altitude);
            document.getElementById('velocity').textContent = Math.round(gameState.velocity * 10) / 10;
            document.getElementById('fuel').textContent = Math.round(gameState.fuel);
            
            // 燃料警告
            if (gameState.fuel < 20) {
                document.getElementById('fuel').className = 'red blink';
            } else if (gameState.fuel < 40) {
                document.getElementById('fuel').className = 'yellow';
            } else {
                document.getElementById('fuel').className = '';
            }
            
            // 速度警告
            if (gameState.velocity > 10) {
                document.getElementById('velocity').className = 'red';
            } else if (gameState.velocity > 5) {
                document.getElementById('velocity').className = 'yellow';
            } else {
                document.getElementById('velocity').className = '';
            }
        }

        function updateGameArea() {
            let altitudeBar = '';
            let barLength = 40;
            let position = Math.round((1000 - gameState.altitude) / 1000 * barLength);
            
            for (let i = 0; i < barLength; i++) {
                if (i === position) {
                    altitudeBar += '▼';
                } else if (i === barLength - 1) {
                    altitudeBar += '█'; // 月面
                } else {
                    altitudeBar += '·';
                }
            }

            let thrustIndicator = gameState.thrustPower > 0 ? '🔥' : '  ';
            let fuelBar = '█'.repeat(Math.round(gameState.fuel / 5));
            
            displayText = `
高度計:
${altitudeBar}

着陸船: ${thrustIndicator}
         ▲
        ███

燃料残量: ${fuelBar}

速度: ${gameState.velocity > 0 ? '↓' : gameState.velocity < 0 ? '↑' : '－'} ${Math.abs(gameState.velocity).toFixed(1)} m/s
            `;
            
            document.getElementById('gameArea').innerHTML = displayText;
        }

        function endGame() {
            gameState.gameRunning = false;
            gameState.gameOver = true;
            clearInterval(gameInterval);
            
            let result = '';
            if (Math.abs(gameState.velocity) <= 5) {
                result = `
🌙 *** 着陸成功！ ***

素晴らしい！月面への軟着陸に成功しました。
着陸速度: ${Math.abs(gameState.velocity).toFixed(1)} m/s
残燃料: ${gameState.fuel}%

月面での任務を開始してください。

                `;
            } else {
                result = `
💥 *** 墜落 ***

着陸船は月面に激突しました。
衝突速度: ${Math.abs(gameState.velocity).toFixed(1)} m/s

次回はもっと慎重に着陸してください。

                `;
            }
            
            document.getElementById('gameArea').innerHTML = result;
            
            // ボタンを即座に有効化してテキストを変更
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = '再チャレンジ';
        }

        // キャンバスの描画処理
        function drawGame() {
            // キャンバスをクリア
            ctx.fillStyle = '#000800';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 月面を描画
            drawLunarSurface();
            
            // 宇宙船を描画
            if (gameState.gameRunning || gameState.gameOver) {
                drawSpacecraft();
            }
            
            // 推進炎を描画
            if (gameState.thrustPower > 0 && gameState.gameRunning && !gameState.gameOver) {
                drawThrustFlame();
            }
            
            // 星を描画
            drawStars();
        }
        
        function drawLunarSurface() {
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = 2;
            
            // 月面のライン
            ctx.beginPath();
            ctx.moveTo(0, canvas.height - 20);
            for (let x = 0; x < canvas.width; x += 20) {
                const y = canvas.height - 20 + Math.sin(x * 0.05) * 3;
                ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // 月面のテクスチャ
            ctx.fillStyle = '#003300';
            for (let x = 10; x < canvas.width; x += 30) {
                for (let y = canvas.height - 15; y < canvas.height; y += 5) {
                    if (Math.random() > 0.7) {
                        ctx.fillRect(x, y, 2, 2);
                    }
                }
            }
        }
        
        function drawSpacecraft() {
            // 宇宙船の位置を計算
            const shipX = canvas.width / 2;
            const shipY = canvas.height - 20 - (gameState.altitude / 1000) * (canvas.height - 40);
            
            ctx.strokeStyle = gameState.isDemo ? '#00ffff' : '#00ff00';
            ctx.fillStyle = gameState.isDemo ? '#004444' : '#003300';
            ctx.lineWidth = 2;
            
            // デモモードの光る効果
            if (gameState.isDemo) {
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 10;
            }
            
            // 宇宙船の本体（三角形）
            ctx.beginPath();
            ctx.moveTo(shipX, shipY - 10);
            ctx.lineTo(shipX - 8, shipY + 5);
            ctx.lineTo(shipX + 8, shipY + 5);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            
            // 着陸脚
            ctx.beginPath();
            ctx.moveTo(shipX - 6, shipY + 5);
            ctx.lineTo(shipX - 10, shipY + 12);
            ctx.moveTo(shipX + 6, shipY + 5);
            ctx.lineTo(shipX + 10, shipY + 12);
            ctx.stroke();
            
            // シャドウをリセット
            ctx.shadowBlur = 0;
        }
        
        function drawThrustFlame() {
            const shipX = canvas.width / 2;
            const shipY = canvas.height - 20 - (gameState.altitude / 1000) * (canvas.height - 40);
            
            // 炎の色をランダムに変化
            const colors = ['#ff6600', '#ff3300', '#ffff00'];
            const flameColor = colors[Math.floor(Math.random() * colors.length)];
            
            ctx.strokeStyle = flameColor;
            ctx.fillStyle = flameColor;
            ctx.lineWidth = 2;
            
            // 炎の形状をランダムに変化
            const flameHeight = 15 + Math.random() * 10;
            const flameWidth = 4 + Math.random() * 4;
            
            ctx.beginPath();
            ctx.moveTo(shipX, shipY + 5);
            ctx.lineTo(shipX - flameWidth, shipY + flameHeight);
            ctx.lineTo(shipX + flameWidth, shipY + flameHeight);
            ctx.closePath();
            ctx.fill();
        }
        
        function drawStars() {
            ctx.fillStyle = '#00ff00';
            // 固定の星の位置
            const stars = [
                {x: 50, y: 50}, {x: 120, y: 30}, {x: 200, y: 70},
                {x: 280, y: 40}, {x: 350, y: 60}, {x: 80, y: 100},
                {x: 300, y: 120}, {x: 150, y: 90}, {x: 320, y: 80}
            ];
            
            stars.forEach(star => {
                if (Math.random() > 0.3) { // 星の点滅
                    ctx.fillRect(star.x, star.y, 1, 1);
                }
            });
        }
        
        // デモモードのAI制御（改善版）
        function updateDemoAI() {
            gameState.demoActionTimer++;
            
            if (!gameState.gameRunning || gameState.gameOver) return;
            
            // 高度と速度に基づいた精密な制御
            const altitudeRatio = gameState.altitude / 1000;
            const velocity = gameState.velocity;
            
            // 目標速度を高度に応じて計算
            let targetVelocity;
            if (altitudeRatio > 0.5) {
                targetVelocity = 8; // 高高度では速めに降下
            } else if (altitudeRatio > 0.3) {
                targetVelocity = 5; // 中高度では中程度
            } else if (altitudeRatio > 0.1) {
                targetVelocity = 3; // 低高度では慎重に
            } else {
                targetVelocity = 1.5; // 着陸直前は非常に慎重に
            }
            
            // 着陸直前の特別制御
            if (gameState.altitude < 50) {
                targetVelocity = Math.min(targetVelocity, 2.5);
            }
            if (gameState.altitude < 20) {
                targetVelocity = Math.min(targetVelocity, 1.5);
            }
            
            // 推進判断の改善
            const velocityDiff = velocity - targetVelocity;
            const shouldThrust = velocityDiff > 0.5; // 目標速度より0.5m/s以上速い場合
            
            // 燃料保存のための制御
            const fuelThreshold = altitudeRatio * 30 + 10; // 高度に応じて燃料保存
            
            // 推進の頻度調整（速度差が大きいほど頻繁に）
            let thrustInterval;
            if (Math.abs(velocityDiff) > 3) {
                thrustInterval = 3; // 緊急時は頻繁に
            } else if (Math.abs(velocityDiff) > 1) {
                thrustInterval = 8; // 通常時
            } else {
                thrustInterval = 15; // 細かい調整
            }
            
            if (shouldThrust && 
                gameState.fuel > fuelThreshold && 
                gameState.demoActionTimer % thrustInterval === 0) {
                thrust();
            }
        }
        
        // デモモードのチェック
        function checkDemoMode() {
            if (gameState.isDemo || gameState.gameRunning) return;
            
            // 5秒間操作がなければデモモード開始
            if (Date.now() - gameState.lastUserInput > 5000) {
                startDemo();
            }
        }
        
        // デモモード開始
        function startDemo() {
            gameState.isDemo = true;
            gameState.demoActionTimer = 0;
            document.getElementById('demoText').style.display = 'block';
            
            // ボタンを有効化してテキストを変更
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'プレイ開始';
            
            // ゲームを自動開始し、デモ用の説明を表示
            setTimeout(() => {
                if (gameState.isDemo) {
                    displayText = `
=== デモンストレーション ===

AIが月面着陸を実演します。

高度と速度を確認しながら、
適切なタイミングでエンジンを点火し、
安全な着陸を目指します。

あなたも挜戦してみましょう！
                    `;
                    document.getElementById('gameArea').innerHTML = displayText;
                    startGame();
                }
            }, 1500);
        }
        
        // デモモード終了
        function stopDemo() {
            if (gameState.isDemo) {
                gameState.isDemo = false;
                document.getElementById('demoText').style.display = 'none';
            }
        }
        
        // キーボード操作
        document.addEventListener('keydown', function(event) {
            // ユーザー入力を記録
            gameState.lastUserInput = Date.now();
            
            // デモモード中の場合は終了
            if (gameState.isDemo) {
                stopDemo();
            }
            
            if (event.key.toLowerCase() === 't') {
                thrust();
            }
        });
        
        // ボタンクリック時もユーザー入力として記録
        document.getElementById('thrustBtn').addEventListener('click', () => {
            gameState.lastUserInput = Date.now();
            if (gameState.isDemo) {
                stopDemo();
            }
        });
        
        document.getElementById('startBtn').addEventListener('click', () => {
            gameState.lastUserInput = Date.now();
            if (gameState.isDemo) {
                stopDemo();
            }
        });

        // メインループを開始
        setInterval(gameLoop, 50); // 20 FPS
        
        // 初期化
        initGame();
        drawGame();
    </script>
</body>
</html>